# SAML Single Sign-On Integration

DataRobot could use external services (Identity Providers, IdP) for user authentication through Single Sign-On (SSO) technology. DataRobot supports SSO based on SAML protocol.

## Enable Single Sign-On

Single Sign-On feature is disabled by default. Update your `config.yaml` to enable SSO:

```yaml
---
app_configuration:
    drenv_override:
        ENABLE_SAML_SSO: true
```

## SSO Configuration Permissions

SSO configuration is disabled by default. There is a flag `Enable SAML SSO configuration management` to enable it. `Manage SSO` tab appears under `APP ADMIN` when `Enable SAML SSO configuration management` is checked.

## SSO Configuration

Single Sign-On should be configured on both Identity Provider and DataRobot sides.

### Identity Provider configuration

Identity Providers implement their own dashborads, so customer should reach IdP's documentation to integrate DataRobot. IdP requires from DataRobot sign in and sign out urls. They are represented on the `Manage SSO` page under `Single Sign-On URL` and `Single Sign-Out URL` settings.
DataRobot expects to receive username and email from the identity provider. IdP should be configured so that the SAML response contains `username` attribute (mandatory) and `email` attribute (optional, recommended).

### DataRobot configuration

`Manage SSO` page represents form for SSO configuration. It has following configuration fields:

* `Entity Id` - Unique identifier. Provided by Identity Provider
* `IdP Metadata URL` - link to XML document with integration specific information

There are following settings in advanced configuration:

* `User Session Length (sec)` - Session cookie expiration time. Default is month
* `SP Initiated Method` - SAML metod which is used to start authentication negotiation
* `IdP Initiated Method` - SAML method which is used to move user to DataRobot after successful authentication
* `Identify Provider Metadata` - XML document with integration specific information (for the case IdP doesn't provide `IdP Metadata URL`)

<img src="images/sso-saml-configuration.png" alt="SSO SAML Configuration" style="border: 1px solid black;" width="500" />

### User impersonation

In order to enable user impersonation on environments with SAML SSO please put the following to `config.yaml`:

```yaml
---
app_configuration:
    drenv_override:
        ENABLE_USER_IMPERSONATION: true
```

The username to use for impersonation will be take from attribute `impersonation_user` of SAML response.

## Sign In

After SSO is configured, Single Sign-On button appears on sign in screen. User is redirected to Identity Provider's authentication page after clicking on it.

User is redirected to DataRobot after successful sign on.

## Base Configuration Examples

## AWS SSO

1. Navigate to the SSO page (from the **Services** tab) and click **Enable AWS SSO**

<kbd><img src="images/sso-saml-aws-config-1.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

2. Click on **Manage SSO access to your cloud applications > Add a new application > Add a custom SAML 2.0 application**:

<kbd><img src="images/sso-saml-aws-config-2.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-aws-config-3.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-aws-config-4.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

3. **Display name** will appear in the user portal and may be an arbitrary name

<kbd><img src="images/sso-saml-aws-config-5.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

4. Copy autogenerated **AWS SSO SAML metadata file** and save this URL as **IdP Metadata URL** on
   the DataRobot SSO Configuration page:

<kbd><img src="images/sso-saml-aws-config-6.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

5. Specify application metadata. **Application ACS URL** should be `<domain>/sso/saml/signed-in` and
   **Application SAML audience** might be an arbitrary string

<kbd><img src="images/sso-saml-aws-config-7.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-aws-config-8.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

6. Save **Application SAML audience** value as **Entity Id** on the DataRobot SSO Configuration
   Page. Also, make sure that **Advanced settings** contain **REDIRECT** in **SP Initiated Method**
   and **POST** in **IdP Initiated Method**

7. On the **Attribute mappings** tab specify and save the following mappings:

	* `Subject` - `subject` - `transient`
	* `username` - `${user:email}` - `unspecified`

<kbd><img src="images/sso-saml-aws-config-9.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

8. Assign users or groups to grant SSO access

<kbd><img src="images/sso-saml-aws-config-10.png" alt="AWS SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>


## Microsoft Azure SSO

1. Sign in to the  [Azure portal](https://portal.azure.com/) as a cloud application admin. In the
   portal, select **Azure Active Directory > Enterprise applications** and select **New application**

<kbd><img src="images/sso-saml-azure-config-1.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

2. Select **Integrate any other application you don’t find in the gallery**, enter the display name,
   then click **Add**

<kbd><img src="images/sso-saml-azure-config-2.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

3. On the app’s **Overview** page, select **Set up single sign-on**, then select **SAML** as the
   single sign-on method

<kbd><img src="images/sso-saml-azure-config-3.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

4. Edit **Basic SAML Configuration**. Type **Identifier (Entity ID)** (an arbitrary string), type
   **Reply URL (Assertion Consumer Service URL)** which should be `<domain>/sso/saml/signed-in/`,
   then save

<kbd><img src="images/sso-saml-azure-config-4.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>


5. Configure **User Attributes & Claims**. Delete all default additional claims and add new claim
   with `username` as **Name**, `Attribute` as **Source**, and `user.userprincipalname` as **Source attribute**.
   If the form prevents saving without **Namespace** value, provide any string, save, then edit it again
   and make **Namespace** empty. After saving the new claim will appear in the table

<kbd><img src="images/sso-saml-azure-config-5.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

6. Add at least one user to the application and make sure the test account has access to the
   application

<kbd><img src="images/sso-saml-azure-config-6.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

7. Copy **Identifier (Entity ID)** and **App Federation Metadata Url** and save them as **Entity ID**
   and **IdP Metadata URL** in the DataRobot SSO Configuration page

<kbd><img src="images/sso-saml-azure-config-7.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-azure-config-8.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

8. Test sign on by hitting **Test** button in step 5, the result should be

<kbd><img src="images/sso-saml-azure-config-9.png" alt="Azure SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

## Oracle Identity Cloud Service SSO

1. Having logged in into Oracle Cloud Console as an administrator navigate to **Service User Console**
   and select **Oracle Identity Cloud Service**

<kbd><img src="images/sso-saml-oracle-config-1.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-oracle-config-2.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="250" height="350" /></kbd>

2. Click on **Add an application** icon and select **SAML Application**

<kbd><img src="images/sso-saml-oracle-config-3.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-oracle-config-4.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

3. On **App Details** page provide an arbitrary name of the application and hit **Next**

<kbd><img src="images/sso-saml-oracle-config-5.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

4. On **SSO Configuration** page specify the following values:

* **Entity ID** - unique name for a service provider, an arbitrary string, should be the same
  as **Entity Id** on DataRobot **Single Sign On Configuration** page

* **Assertion Consumer URL** - **Single Sign-On URL** value copied from DataRobot
  **Single Sign On Configuration** page, has form of `<domain>/sso/saml/signed-in/`

* **NameID Format** - select **Custom** and specify `urn:oasis:names:tc:SAML:2.0:nameid-format:transient`
  value

* **NameID Value** - select **Primary Email**

* In **Attribute Configuration** section add an attribute with username as **Name**,
  select Unspecified as **Format**, User Attribute as **Type**, and Primary Email as **Value**

<kbd><img src="images/sso-saml-oracle-config-6.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

5. Hit **Finish**

6. Go back to **SSO Configuration** tab and click **Download Identity Provider Metadata**.
   Copy the content of downloaded **IDCSMetadata.xml** file and save as **Identity Provider Metadata**
   on DataRobot **Single Sign On Configuration** page. Also, make sure that **IdP Metadata URL**
   field is empty

<kbd><img src="images/sso-saml-oracle-config-7.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

<kbd><img src="images/sso-saml-oracle-config-8.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

7. Activate the application

<kbd><img src="images/sso-saml-oracle-config-9.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

8. Assign users or groups on a corresponding tab

<kbd><img src="images/sso-saml-oracle-config-10.png" alt="Oracle SSO SAML Configuration" style="border: 1px solid black;" width="500" /></kbd>

9. Test the application integration by logging in into DataRobot using user assigned
   on the previous step

## Advanced SSO Configuration

Some advanced configuration options are not exposed in UI and are
available via admin SSO configuration API.

In order to use that API administrator needs to have regular SSO
management permissions and grab API token from own profile in UI
(referred as `<API_TOKEN>` below).

### Encrypted Request

In order to enable authentication request signing please

1. put your encryption certificate and key files into `/opt/datarobot/DataRobot-6.x.x/etc/certs/`,
2. configure the application:

```bash
curl '<DATAROBOT_ENDPOINT>/api/v2/admin/sso/saml/configuration/global/' -X PATCH -H 'Content-Type: application/json;charset=UTF-8' -H 'Authorization: Token <API_TOKEN>' --data-binary '
{
  "advancedConfiguration": {
    "samlClientConfiguration": {
      "service": {"sp": {"authn_requests_signed": true}},
      "key_file" : "/opt/datarobot/etc/certs/key.pem",
      "cert_file" : "/opt/datarobot/etc/certs/cert.pem"
    }
  }
}'
```

### Encrypted Response

If SAML identity provider ecnrypts response assertions, please

1. put your encryption certificate and key files into `/opt/datarobot/DataRobot-6.x.x/etc/certs/`,
2. configure the application to use that certificate:

```bash
curl '<DATAROBOT_ENDPOINT>/api/v2/admin/sso/saml/configuration/global/' -X PATCH -H 'Content-Type: application/json;charset=UTF-8' -H 'Authorization: Token <API_TOKEN>' --data-binary '
{
  "advancedConfiguration": {
    "samlClientConfiguration": {
      "encryption_keypairs" : [{
        "key_file" : "/opt/datarobot/etc/certs/key.pem",
        "cert_file" : "/opt/datarobot/etc/certs/cert.pem"
      }]
    }
  }
}'
```

#### Encrypted Response with Okta

When using encrypted assertions with Okta, please additionally specify `id_attr_name`:

```bash
curl '<DATAROBOT_ENDPOINT>/api/v2/admin/sso/saml/configuration/global/' -X PATCH -H 'Content-Type: application/json;charset=UTF-8' -H 'Authorization: Token <API_TOKEN>' --data-binary '
{
  "advancedConfiguration": {
    "samlClientConfiguration": {
      "encryption_keypairs" : [{
        "key_file" : "/opt/datarobot/etc/certs/key.pem",
        "cert_file" : "/opt/datarobot/etc/certs/cert.pem"
      }],
      "id_attr_name" : "Id"
    }
  }
}'
```
